---
title: "STATS331Final Q"
subtitle: "Checkpoint4 Linear Regression"
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
    number-sections: true
editor: visual
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r setup}
#| include: false
library(tidyverse)
library(ggplot2)
```

## Dataset

For this project, we are working with two datasets, murders/100k people and armed forces personnel as a percent of the labor force. Both of these datasets give their respective variable per country and in every available year, which ranges from 1950 to 2020. The murder data is sourced from the Global Burden of Disease Study 2017 (<https://ghdx.healthdata.org/gbd-2017>) and the armed forces data is sourced from the International Institute for Strategic Studies.

```{r}
Soldierdata <- read.csv("armed_forces_personnel_percent_of_labor_force.csv")
Murderdata <- read.csv("murder_per_100000_people.csv")
```

## Cleaning Data

```{r}
colnames(Soldierdata) <- gsub("^X", "", colnames(Soldierdata))
colnames(Murderdata) <- gsub("^X", "", colnames(Murderdata))

Soldierdata$country <- str_trim(Soldierdata$country)
Murderdata$country <- str_trim(Murderdata$country)

Soldierdata[is.na(Soldierdata)] <- 0
Murderdata[is.na(Murderdata)] <- 0

Soldierdata_long <- pivot_longer(Soldierdata, cols = -country, names_to = "year", values_to = "soldiers")
Murderdata_long <- pivot_longer(Murderdata, cols = -country, names_to = "year", values_to = "murder_rate")

FinalData <- full_join(Soldierdata_long, Murderdata_long, by = c("country", "year"))

FinalData
```

## Linear Regression

```{r}
ggplot(FinalData, aes(x = soldiers, y = murder_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Military Personnel vs. Murder Rate",
       x = "Military Personnel (% of Labor Force)",
       y = "Murder Rate (per 100,000 people)")


```

```{r}
summary_data_year <- FinalData |>
  group_by(year) |>
  summarize(
    avg_soldiers = mean(soldiers, na.rm = TRUE),
    avg_murder_rate = mean(murder_rate, na.rm = TRUE))

ggplot(summary_data_year, aes(x = as.numeric(year))) +
  geom_line(aes(y = avg_murder_rate, color = "Murder Rate"), size = 1) +
  geom_line(aes(y = avg_soldiers * 2, color = "Military Personnel (Scaled)"), size = 1, linetype = "dashed") +
  scale_y_continuous(name = "Murder Rate (per 100,000 people)",
                     sec.axis = sec_axis(~./2, name = "Military Personnel (% of Labor Force)")) +
  labs(title = "Trends in Murder Rate and Military Personnel Over Time",
       x = "Year") +
  scale_color_manual(values = c("Murder Rate" = "red", "Military Personnel (Scaled)" = "blue")) +
  theme_bw()

```


```{r}
summary_data <- FinalData |>
  group_by(country) |>
  summarize(
    avg_soldiers = mean(soldiers, na.rm = TRUE),
    avg_murder_rate = mean(murder_rate, na.rm = TRUE)
  )

model <- lm(avg_murder_rate ~ avg_soldiers, data = summary_data)
summary(model)
coefficients(model)
```

```{r}
fitted_values <- fitted(model)
residuals <- resid(model)

variance_response <- var(summary_data$avg_murder_rate, na.rm = TRUE)
variance_fitted <- var(fitted_values, na.rm = TRUE)
variance_residuals <- var(residuals, na.rm = TRUE)

library(knitr)
library(kableExtra)

data.frame(
  "Variance in Response" = variance_response,
  "Variance in Fitted" = variance_fitted,
  "Variance in Residuals" = variance_residuals
) |>
  kable() |>
  kable_styling(full_width = FALSE)

r_squared <- variance_fitted / variance_response
r_squared
```
